@page "/"
@using BlazorUnitedApp.Data
@inject PersistentComponentState ApplicationState
@implements IDisposable
@attribute [RenderModeWebAssembly]

<PageTitle>Index</PageTitle>

<EditForm Model="Value" method="POST" OnSubmit="DisplayCustomer" FormName="customer">  
    <div>
        <label>
            <span>Name</span>
            <InputText @bind-Value="Value!.Name" />
        </label>
    </div>
    <AddressEditor @bind-Value="Value.BillingAddress" />
    <input type="submit" value="Send" />
</EditForm>

@if (_submitted)
{
    <!-- Display customer data -->
    <h3>Customer</h3>
    <p>Name: @Value!.Name</p>
    <p>Street: @Value.BillingAddress.Street</p>
    <p>City: @Value.BillingAddress.City</p>
    <p>State: @Value.BillingAddress.State</p>
    <p>Zip: @Value.BillingAddress.Zip</p>
}

@code {
    static int count;

    private PersistingComponentStateSubscription persistingSubscription;

    public void DisplayCustomer()
    {
        _submitted = true;
    }

    [SupplyParameterFromForm] Customer? Value { get; set; }

    protected override void OnInitialized()
    {
        persistingSubscription = ApplicationState.RegisterOnPersisting(() =>
        {
            ApplicationState.PersistAsJson("myperson", Value);
            return Task.CompletedTask;
        });

        if (!ApplicationState.TryTakeFromJson<Customer>("myperson", out var restored))
        {
            Value = new Customer { Name = $"Persisted Customer {++count}" };
        }
        else
        {
            Value = restored;
        }
    }

    bool _submitted = false;
    public void Submit() => _submitted = true;

    void IDisposable.Dispose()
    {
        persistingSubscription.Dispose();
    }
}
